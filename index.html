<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    
    <!-- Web App Meta Tags -->
    <meta name="application-name" content="GEMS">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Gems">
    <meta name="theme-color" content="#433D37">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/assets/icons/apple-touch-icon-152.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/assets/icons/apple-touch-icon-120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/assets/icons/apple-touch-icon-76.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/assets/icons/apple-touch-icon-60.png">
    <link rel="apple-touch-icon-precomposed" href="https://gems.b-cdn.net/Pasted%20Graphic.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="16x16" href="https://gems.b-cdn.net/favicon-16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://gems.b-cdn.net/favicon-16.png">
    <link rel="apple-touch-icon" href="https://gems.b-cdn.net/favicon-16.png">

	<!-- Fonts --->
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/shared/fonts.css?v=<%=Date.now()%>">
    <link rel="manifest" href="/shared/manifest.json">

    <title>Gems</title>
    <script type="module" src="/shared/index.js?v=<%=Date.now()%>"></script>

    <!-- Social Sharing Metadata -->
    <meta property="og:title" content="Gems">
    <meta property="og:description" content="Prototype">
    <meta property="og:image" content="https://gems.b-cdn.net/Pasted%20Graphic.png">
    <meta property="og:url" content="https://proto.gems.fan">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Gems">
    <meta name="twitter:description" content="Prototype">
    <meta name="twitter:image" content="/assets/share/og-image.png?v=<%=Date.now()%>">

    <!-- Open Graph / Social Share Image -->
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">

    <!-- Mixpanel -->
    <script type="text/javascript">
        (function(f,b){if(!b.__SV){var e,g,i,h;window.mixpanel=b;b._i=[];b.init=function(e,f,c){function g(a,d){var b=d.split(".");2==b.length&&(a=a[b[0]],d=b[1]);a[d]=function(){a.push([d].concat(Array.prototype.slice.call(arguments,0)))}}var a=b;"undefined"!==typeof c?a=b[c]=[]:c="mixpanel";a.people=a.people||[];a.toString=function(a){var d="mixpanel";"mixpanel"!==c&&(d+="."+c);a||(d+=" (stub)");return d};a.people.toString=function(){return a.toString(1)+".people (stub)"};i="disable time_event track track_pageview track_links track_forms track_with_groups add_group set_group remove_group register register_once alias unregister identify name_tag set_config reset opt_in_tracking opt_out_tracking has_opted_in_tracking has_opted_out_tracking clear_opt_in_out_tracking start_batch_senders people.set people.set_once people.unset people.increment people.append people.union people.track_charge people.clear_charges people.delete_user people.remove".split(" ");
        for(h=0;h<i.length;h++)g(a,i[h]);var j="set set_once union unset remove delete".split(" ");a.get_group=function(){function b(c){d[c]=function(){call2_args=arguments;call2=[c].concat(Array.prototype.slice.call(call2_args,0));a.push([e,call2])}}for(var d={},e=["get_group"].concat(Array.prototype.slice.call(arguments,0)),c=0;c<j.length;c++)b(j[c]);return d};b._i.push([e,f,c])};b.__SV=1.2;e=f.createElement("script");e.type="text/javascript";e.async=!0;e.src="undefined"!==typeof MIXPANEL_CUSTOM_LIB_URL?
        MIXPANEL_CUSTOM_LIB_URL:"file:"===f.location.protocol&&"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js".match(/^\/\//)?"https://cdn.mxpnl.com/libs/mixpanel-2-latest.min.js":"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js";g=f.getElementsByTagName("script")[0];g.parentNode.insertBefore(e,g)}})(document,window.mixpanel||[]);
    
        // Initialize with your project token
        mixpanel.init('475cc786eb389463ae2d8c5b4e989c86');
    
        // Track pageview
        mixpanel.track('Page View', {
            'page': window.location.pathname
        });
    </script>

    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            font-family: "Poppins", Helvetica, Arial, sans-serif;
            font-size: 16px;
            background-color: #433D37;
            color: rgba(0, 0, 0, 0.7);  /* Default to dark text */
        }
        
        /* Add styles for the button container */
        .gem-buttons {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 30;
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 10px;
            pointer-events: none; /* Allow clicks to pass through the container */
            width: 100%;
            max-width: 500px;
            align-items: center;
        }

        .gem-button {
            padding: 10px 16px;
            border: none;
            border-radius: 3em;
            background-color: rgba(0, 0, 0, 0.2);
            color: rgba(255, 255, 255, 0.95);
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: "Poppins", Helvetica, Arial, sans-serif;
            font-size: 1em;
            font-weight: 300;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            pointer-events: auto;
            width: 140px;
            text-align: center;
            opacity: 0.8;
            white-space: nowrap;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.4),
                         0 0 20px rgba(255, 255, 255, 0.2);
            letter-spacing: 0.04em;
        }

        /* Wrapper for WARP buttons to be in a row */
        .gem-buttons > .gem-button {
            display: inline-block;
            margin: 0 5px;
        }

        /* Info button styling */
        .info-button {
            font-family: "Poppins", Helvetica, Arial, sans-serif;
            font-size: 1em;
            font-weight: 300;
            color: rgba(255, 255, 255, 0.99);
            text-decoration: none;
            text-align: center;
            pointer-events: auto;
            transition: all 0.3s ease;
            opacity: 0.95;
            letter-spacing: 0.04em;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.7);
        }

        .info-button:hover {
            color: rgba(255, 255, 255, 0.99);
            opacity: 0.9;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.9);
        }

        .info-link-wrapper {
            margin-top: 5px;
        }
        
        .gem-button:hover {
            background-color: rgba(0, 0, 0, 0.25);
            opacity: 0.9;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5),
                         0 0 30px rgba(255, 255, 255, 0.3);
        }

        .gem-button.active {
            background-color: rgba(0, 0, 0, 0.3);
            opacity: 1;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5),
                         0 0 30px rgba(255, 255, 255, 0.3);
        }
        
        gem-player {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: block;
            opacity: 1;
            transition: opacity 0.5s ease-in-out;
        }
        
        gem-player.fade-out {
            opacity: 0;
        }
        
        /* Fade-in transition for canvas */
        .gem-canvas {
            opacity: 0;
            transition: opacity 0.8s ease-in-out;
        }
        
        .gem-canvas.loaded {
            opacity: 1;
        }
        
        /* Text overlay container */
        .text-overlay {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 1.5%;
            text-align: left;
            margin-left: 2em;
            pointer-events: none;
            z-index: 20;
            animation: fadeIn 1s ease-in-out forwards;
            opacity: 0;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .text-overlay div {
            font-size: 1em;
        }
        
        .artist-name {
            font-size: 1.5em !important;
            font-weight: 500;
            margin-bottom: -0.2em;
            opacity: 0.8;
        }
        
        .album-title {
            font-size: 1em !important;
            font-weight: 300;
            opacity: 0.4;
        }

        .published {
            position: absolute;
            bottom: 4%;
            text-align: left;
            pointer-events: none;
            z-index: 10;
            font-size: 0.74em !important;
            opacity: 0.4;
            margin-left: 2em;
        }

		#panel-overlay {
			display: flex;
			visibility: hidden;
			opacity: 0;
			z-index: 10;
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background-color: rgba(67, 61, 56, 0.5);
			justify-content: center;
			align-items: center;
			font-size: 4em !important;
			font-weight: 500;
			color: rgba(255, 255, 255, 0.5);
			text-shadow: 0 0 64px rgba(255, 255, 255, 0.7);
			letter-spacing: 10;
			-webkit-backdrop-filter: blur(10px);
			backdrop-filter: blur(10px);
			transition: 0.5s;
		}

		.kern-pair {
			display: inline-block;
			letter-spacing: -0.15em;
			margin-right: 0.05em;
		}

        /* Add transition overlay */
        .transition-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            pointer-events: none;
            z-index: 25;
            transition: opacity 0.5s ease-in-out, background-color 0.5s ease-in-out;
        }

        .transition-overlay.active {
            opacity: 1;
        }

        /* Mobile styles */
        @media (max-width: 480px) {
            .gem-buttons {
                padding: 8px;
                gap: 6px;
                bottom: calc(env(safe-area-inset-bottom, 10px) + 20px);
            }

            .gem-button {
                padding: 6px 8px;
                font-size: 0.85em;
                width: auto;
                min-width: 80px;
                letter-spacing: 0.02em;
            }
            
            .info-button {
                font-size: 0.85em;
                letter-spacing: 0.02em;
            }

            .published {
                display: none;
            }
        }

        /* Small mobile styles */
        @media (max-width: 360px) {
            .gem-buttons {
                padding: 6px;
                gap: 4px;
                bottom: calc(env(safe-area-inset-bottom, 10px) + 50px);
            }

            .gem-button {
                padding: 5px 6px;
                font-size: 0.8em;
                min-width: 70px;
            }
            
            .info-button {
                font-size: 0.8em;
            }
        }

    </style>
</head>
<body>
    <!-- 
        Performance note: The Aphex Twin gem file (WARP21) is significantly larger (9.5MB) 
        than the other gem files (Flying Lotus: 3.1MB, Oneohtrix: 1.9MB).
        This larger file size causes a slightly longer loading time when switching to WARP21.
    -->
    <div class="transition-overlay"></div>
    <div class="gem-buttons">
        <div class="warp-buttons-row" style="display: flex; gap: 10px; justify-content: center; width: 100%;">
            <button class="gem-button" data-gem="aphex-twin">WARP21</button>
            <button class="gem-button" data-gem="flying-lotus">WARP195</button>
            <button class="gem-button" data-gem="oneohtrix">WARP318</button>
        </div>
        <div class="info-link-wrapper" style="width: 100%; display: flex; justify-content: center; margin-top: 10px;">
            <a href="https://docsend.com/v/jgymp/how" target="_blank" class="info-button">How do Gems work?</a>
        </div>
    </div>

    <div id="gem-container">
    </div>

    <script>
        // Define the gems data
        const gems = {
            'flying-lotus': {
                url: '/assets/gems/flying-lotus-cosmogramma.gem',
                artist: 'Gems',
                album: 'Reinventing digital albums',
                published: '© 2010 Warp Records',
                bgColor: '#433D37',
                textColor: '#f0f0f0'  // Light text on dark background
            },
            'aphex-twin': {
                url: '/assets/gems/aphex-twin-selected-ambient-works-ii.gem',
                artist: 'Gems',
                album: 'Reinventing digital albums',
                published: '© 1994 Warp Records',
                bgColor: '#BEC3C9',
                textColor: 'rgba(0, 0, 0, 0.7)'  // Dark text on light background
            },
            'oneohtrix': {
                url: '/assets/gems/one-oh-trix-point-never-magic-otp.gem',
                artist: 'Gems',
                album: 'Reinventing digital albums',
                published: '© 2020 Warp Records',
                bgColor: '#89776C',
                textColor: 'rgba(0, 0, 0, 0.7)'  // Dark text on light background
            }
        };

        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded');
            const buttons = document.querySelectorAll('.gem-button');
            const transitionOverlay = document.querySelector('.transition-overlay');
            
            // Create an object to cache loaded gem content
            const gemCache = {};
            // Flag to prevent multiple simultaneous transitions
            let isTransitioning = false;
            
            // Function to update button states
            function updateButtonStates(activeGem) {
                buttons.forEach(btn => {
                    if (btn.getAttribute('data-gem') === activeGem) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
            }

            // Function to initialize the first gem without animation
            function initializeGem(gemType) {
                console.log('Initializing gem:', gemType);
                const gemData = gems[gemType];
                if (!gemData) {
                    console.error('No data found for gem:', gemType);
                    return;
                }

                // Update button states
                updateButtonStates(gemType);

                // Store the selected gem type
                localStorage.setItem('selectedGem', gemType);
                
                // Update URL based on gem type
                const urlMap = {
                    'aphex-twin': '/warp/21',
                    'flying-lotus': '/warp/195',
                    'oneohtrix': '/warp/318'
                };
                const newUrl = urlMap[gemType];
                if (newUrl) {
                    window.history.pushState({gemType: gemType}, '', newUrl);
                }

                // Set body text color and background 
                // These are set first on initial load (no transition)
                document.body.style.backgroundColor = gemData.bgColor;
                document.body.style.color = gemData.textColor;
                
                // Prepare the transition overlay but keep it hidden initially
                transitionOverlay.style.backgroundColor = gemData.bgColor;
                
                // Create a new gem-player element immediately
                const container = document.getElementById('gem-container');
                container.innerHTML = `
                    <gem-player 
                        url="${gemData.url}"
                        artist="${gemData.artist}"
                        album="${gemData.album}"
                        published="${gemData.published}"
                        style="background-color: ${gemData.bgColor}">
                    </gem-player>
                `;
                
                // No need to fade in since this is the initial load
                const player = container.querySelector('gem-player');
                if (player) {
                    player.addEventListener('sceneerror', (event) => {
                        console.error('Scene error:', event.detail.error);
                    });
                }
            }

            // Function to switch gems with transition animation
            async function switchGem(gemType) {
                // Prevent rapid switching
                if (isTransitioning) {
                    console.log('Already transitioning, ignoring switch request');
                    return;
                }
                
                // Check if we're already on this gem type
                const currentGemType = localStorage.getItem('selectedGem');
                if (currentGemType === gemType) {
                    console.log('Already showing gem:', gemType);
                    return;
                }
                
                console.log('Switching to gem:', gemType);
                const gemData = gems[gemType];
                if (!gemData) {
                    console.error('No data found for gem:', gemType);
                    return;
                }
                
                // Set transitioning flag
                isTransitioning = true;

                // Update button states
                updateButtonStates(gemType);

                // Store the selected gem type
                localStorage.setItem('selectedGem', gemType);
                
                // Update URL based on gem type
                const urlMap = {
                    'aphex-twin': '/warp/21',
                    'flying-lotus': '/warp/195',
                    'oneohtrix': '/warp/318'
                };
                const newUrl = urlMap[gemType];
                if (newUrl) {
                    window.history.pushState({gemType: gemType}, '', newUrl);
                    // Track page view in Mixpanel when URL changes
                    mixpanel.track('Page View', {
                        'page': newUrl,
                        'artist': gemData.artist,
                        'album': gemData.album
                    });
                }
                
                // Attempt to preload the gem file in advance
                if (!gemCache[gemType]) {
                    console.log('Preloading gem:', gemData.url);
                    try {
                        const preloadLink = document.createElement('link');
                        preloadLink.rel = 'preload';
                        preloadLink.href = gemData.url;
                        preloadLink.as = 'fetch';
                        document.head.appendChild(preloadLink);
                    } catch (e) {
                        console.warn('Preloading not supported:', e);
                    }
                }
                
                // Get the current gem-player
                const currentPlayer = document.querySelector('gem-player');
                if (!currentPlayer) {
                    console.error('No gem-player found');
                    isTransitioning = false;
                    return;
                }
                
                // Set overlay to match the new background color
                transitionOverlay.style.backgroundColor = gemData.bgColor;
                
                // DO NOT change text color until after transition
                // document.body.style.color = gemData.textColor;
                
                // Fade out current content
                currentPlayer.classList.add('fade-out');
                transitionOverlay.classList.add('active');

                // Wait for fade out
                await new Promise(resolve => setTimeout(resolve, 350));

                // Now it's safe to change background and text colors
                document.body.style.backgroundColor = gemData.bgColor;
                document.body.style.color = gemData.textColor;

                // Clean up any existing text overlays
                const existingOverlays = document.querySelectorAll('.text-overlay');
                existingOverlays.forEach(overlay => overlay.remove());

                try {
                    // Important: Remove the old player first and wait a moment for cleanup
                    document.getElementById('gem-container').innerHTML = '';
                    
                    // Wait a moment to ensure proper cleanup
                    await new Promise(resolve => setTimeout(resolve, 50));
                    
                    // Create a new gem-player element
                    const container = document.getElementById('gem-container');
                    container.innerHTML = `
                        <gem-player 
                            url="${gemData.url}"
                            artist="${gemData.artist}"
                            album="${gemData.album}"
                            published="${gemData.published}"
                            style="background-color: ${gemData.bgColor}">
                        </gem-player>
                    `;

                    // Store that we've loaded this gem before
                    gemCache[gemType] = true;
                    
                    // Add error event listener to the new gem-player
                    const player = container.querySelector('gem-player');
                    if (player) {
                        player.addEventListener('sceneerror', (event) => {
                            console.error('Scene error:', event.detail.error);
                            isTransitioning = false;
                        });
                        
                        // When the scene is loaded, fade in content and clear transitioning flag
                        player.addEventListener('sceneloaded', () => {
                            // Wait a brief moment for the new content to initialize
                            setTimeout(() => {
                                // Fade in new content
                                transitionOverlay.classList.remove('active');
                                player.classList.remove('fade-out');
                                
                                // Clear transitioning flag
                                isTransitioning = false;
                                console.log('Transition complete to:', gemType);
                            }, 200);
                        });
                    }
                } catch (error) {
                    console.error('Error switching gem:', error);
                    transitionOverlay.classList.remove('active');
                    isTransitioning = false;
                }
            }

            // Function to get initial gem type from URL
            function getInitialGemType() {
                const match = window.location.pathname.match(/\/warp\/(\d+)/);
                if (match) {
                    const numberMap = {
                        '21': 'aphex-twin',
                        '195': 'flying-lotus',
                        '318': 'oneohtrix'
                    };
                    return numberMap[match[1]] || 'aphex-twin';
                }
                
                // If we're at the root path, explicitly use Aphex Twin
                if (window.location.pathname === '/') {
                    return 'aphex-twin';
                }
                
                return 'aphex-twin';
            }

            // Initialize with URL-based gem or default to aphex-twin
            const initialGem = getInitialGemType();
            console.log('Initial gem from URL:', initialGem);
            
            // Use initializeGem for the first load - it's faster and doesn't need transitions
            initializeGem(initialGem);
            
            // Add click handlers to buttons
            buttons.forEach(button => {
                button.addEventListener('click', function() {
                    const gemType = this.getAttribute('data-gem');
                    console.log('Button clicked, switching to gem:', gemType);
                    switchGem(gemType);  // Use the animated transition for clicks
                });
            });
            
            // Add popstate event listener to handle browser back/forward buttons
            window.addEventListener('popstate', function(event) {
                console.log('popstate event triggered', event.state);
                // If we have state data with gemType, use that
                if (event.state && event.state.gemType) {
                    switchGem(event.state.gemType);
                } else {
                    // Otherwise, try to determine the gem type from the URL
                    const gemType = getInitialGemType();
                    switchGem(gemType);
                }
            });
        });
    </script>
</body>
</html> 